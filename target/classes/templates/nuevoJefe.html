<!DOCTYPE html>
<html lang="es" xmlns:th="https://www.thymeleaf.org">
<head th:replace="home  :: head">
	<meta charset="UTF-8">
	<title>Nuevo Jefe</title>
</head>
<body>
	
	<!-- Main container -->
	<main class="full-box main-container">
		<!-- Nav lateral -->
    <section class="full-box nav-lateral">
		<div class="full-box nav-lateral-bg show-nav-lateral"></div>
			<div class="full-box nav-lateral-content" th:replace="home :: nav-lateral">
		</div>
    </section>

		<!-- Page content -->
		<section class="full-box page-content">
			<nav class="full-box navbar-info">
				<a href="#" class="float-left show-nav-lateral">
					<i class="fas fa-exchange-alt"></i>
				</a>
				<a href="user-update.html">
					<i class="fas fa-user-cog"></i>
				</a>
				<a href="#" class="btn-exit-system">
					<i class="fas fa-power-off"></i>
				</a>
			</nav>

			<!-- Page header -->
			<div class="full-box page-header">
				<h3 class="text-left">
					<i class="fas fa-plus fa-fw"></i> &nbsp; AGREGAR JEFE DE PRESTAMISTA
				</h3>
			</div>

			<div class="container-fluid">
				<ul class="full-box list-unstyled page-nav-tabs">
					<li>
						<a class="active" href="/nuevoJefe"><i class="fas fa-plus fa-fw"></i> &nbsp; AGREGAR JEFE</a>
					</li>
					<li>
						<a href="/listaJefe"><i class="fas fa-clipboard-list fa-fw"></i> &nbsp; LISTA DE JEFES</a>
					</li>
					<li>
						<a href="/buscarJefe"><i class="fas fa-search fa-fw"></i> &nbsp; BUSCAR JEFE</a>
					</li>
				</ul>	
			</div>
			
			<!-- Content here-->
			<div class="container-fluid">
				<form id="FormSave" th:action="@{/registrarJefe}" th:object="${jefe}" method="post"  class="form-neon" autocomplete="off">
				<div align="center" th:if=${param.registroExitoso}>
						<div class="alert alert-info">Jefe Registrado Exitosamente</div>
				</div>
					<div align="center" th:if="${mensaje != null}" class="alert alert-danger">
						<p th:text="${mensaje}"></p>
					 </div>
					<fieldset>
						<legend><i class="fas fa-user"></i> &nbsp; Información básica</legend>
						<div class="container-fluid">
							<div class="row">
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="username" class="bmd-label-floating">Usuario</label>
										<input th:field="*{username}" type="text" pattern="^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ ]{1,40}$" class="form-control" name="username" id="username" th:value="${jefe.username}" maxlength="100" title="Ingresa un usuario correcto" required>
										<p th:if="${#fields.hasErrors('username')}" th:errors="*{username}" class="error-message"></p>
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="usuario_nombre" class="bmd-label-floating">Nombres</label>
										<input th:field="*{nombres}" type="text" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ ]{1,40}" class="form-control" name="nombres" id="usuario_nombre" th:value="${jefe.nombres}" maxlength="50" title="Ingresa nombres correctos" required>
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="usuario_apepaterno" class="bmd-label-floating">Apellido Paterno</label>
										<input th:field="*{apePaterno}" type="text" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ ]{1,50}" class="form-control" name="apePaterno" id="usuario_apepaterno" th:value="${jefe.apePaterno}" maxlength="50" title="Ingresa un apellido correcto" required>
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="usuario_apematerno" class="bmd-label-floating">Apellido Materno</label>
										<input th:field="*{apeMaterno}" type="text" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ ]{1,50}" class="form-control" name="apeMaterno" id="usuario_apematerno" th:value="${jefe.apeMaterno}" title="Ingresa un apellido correcto" maxlength="50">
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="email" class="bmd-label-floating">Email</label>
										<input th:field="*{email}" type="text" pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" class="form-control" name="email" id="email" maxlength="100" title="Ingresa un email correcto" required>
										<p th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="error-message"></p>
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="password" class="bmd-label-floating">Contraseña</label>
										<input th:field="*{password}" type="password"  class="form-control" name="password" id="password" th:value="${jefe.password}" maxlength="40" required>
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="cliente_telefono" class="bmd-label-floating">Teléfono</label>
										<input th:field="*{telefono}" type="number" pattern="[0-9()+]{1,20}" class="form-control" name="telefono" id="telefono" th:value="${jefe.telefono}" maxlength="20" required>
										<p th:if="${#fields.hasErrors('telefono')}" th:errors="*{telefono}" class="error-message"></p>
									</div>
								</div>
								<div class="col-12 col-md-6">
									<div class="form-group">
										<label for="cliente_dni" class="bmd-label-floating">DNI</label>
										<input th:field="*{dni}" type="number" pattern="\d{8}" class="form-control" name="dni" id="dni" th:value="${jefe.dni}" maxlength="8" title="Ingresa 8 dígitos numéricos" required>
										<p th:if="${#fields.hasErrors('dni')}" th:errors="*{dni}" class="error-message"></p>
									</div>
								</div>
								<div class="col-12 col-md-6">
								        <div class="form-group">
								            <label for="zona" class="bmd-label-floating">Zona</label>
								            <select id="zona" class="form-control" name="idZona">
								                <option disabled value="">Selecciona una zona</option>
								                <option th:each="zona : ${listzonas}" th:value="${zona.idZona}" th:text="${zona.descripcion}"></option>
								            </select>
								        </div>
								</div>
								<div class="col-12 col-md-4" style="display: none;">
									<div class="form-group">
										<label for="estado" class="bmd-label-floating">Estado</label>
										<input type="number"  class="form-control" name="estado" id="estado" value="0" readonly>
									</div>
								</div>
								<div class="col-12 col-md-4" style="display: none;">
								    <div class="form-group">
								        <label for="idUsuarioLider" class="bmd-label-floating">ID Usuario Líder</label>
								        <input type="number" class="form-control" name="idUsuarioLider" id="idUsuarioLider" th:value="${idUsuario}" readonly>
								    </div>
								</div>
								<div class="col-12 col-md-4" style="display: none;">
									<div class="form-group">
										<label for="estado" class="bmd-label-floating">idRol</label>
										<input type="number"  class="form-control" name="idRol" id="idRol" value="4" readonly>
									</div>
								</div>

							</div>
						</div>
					</fieldset>
					<br><br><br>
					<p class="text-center" style="margin-top: 40px;">
						<button type="reset" class="btn btn-raised btn-secondary btn-sm"><i class="fas fa-paint-roller"></i> &nbsp; LIMPIAR</button>
						&nbsp; &nbsp;
						<button type="submit" id="btnGuardar" class="btn btn-raised btn-info btn-sm"><i class="far fa-save"></i> &nbsp; GUARDAR</button>
					</p>
				</form>
			</div>	

		</section>
	</main>

	<script src="/js/jquery-3.6.0.min.js"></script>
	<script src="/js/sweetalert2@11.js"></script>

	<script>
		$(document).ready(function() {
        // Llamar a validateForm() al cargar la página para marcar los campos vacíos
        validateForm();

        // Llamar a validateForm() cada vez que los campos cambien para actualizar las marcas de validación
            $('#FormSave input[type="text"], #FormSave input[type="password"]').on('input', function() {
                validateForm();
            });

            $('#FormSave').submit(function(e) {
                e.preventDefault(); // Evita que el formulario se envíe automáticamente

                // Validar que no haya campos vacíos antes de enviar el formulario
                if (!validateForm()) {
                    // Mostrar alerta de SweetAlert cuando hay campos vacíos
                    Swal.fire(
                        'Error',
                        'Por favor completa todos los campos requeridos.',
                        'error'
                    );
                    return; // Detener el envío del formulario si hay campos vacíos
                }

                // Guardar una referencia al formulario
                var form = $(this);

                Swal.fire({
                    title: '¿Estás seguro?',
                    text: '¿Quieres guardar el registro?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, guardar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Si el usuario confirma, enviar el formulario con AJAX
                        $.ajax({
                            url: form.attr('action'), // URL del endpoint
                            method: form.attr('method'), // Método HTTP (POST en este caso)
                            data: form.serialize(), // Datos del formulario
                            success: function(response) {
                                // Manejar la respuesta del servidor aquí
                                console.log(response);
                                // Mostrar mensaje de éxito y redirigir
                                Swal.fire(
                                    'Guardado',
                                    'Los cambios han sido guardados exitosamente.',
                                    'success'
                                ).then(() => {
                                    window.location.href = '/listaJefe';
                                });
                            },
                            error: function(xhr, status, error) {
                                // Manejar errores de AJAX aquí
                                console.error(xhr.responseText);
                                Swal.fire(
                                    'Error',
                                    'Ha ocurrido un error al guardar los cambios.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            });

            // Función para validar que no haya campos vacíos ni patrones incorrectos
            function validateForm() {
                var isValid = true;
                // Iterar sobre los campos del formulario
                $('#FormSave input[type="text"], #FormSave input[type="password"]').each(function() {
                    // Verificar si el campo está vacío o no cumple con el patrón
                    if ($(this).val() === '' || !validatePattern($(this))) {
                        isValid = false;
                        $(this).addClass('is-invalid'); // Marcar campo como inválido
                        $(this).next('.invalid-feedback').text('Por favor completa este campo correctamente.').show(); // Mostrar mensaje de validación
                        $(this).next('.valid-feedback').hide(); // Ocultar mensaje de validación de éxito si estaba visible
                        $(this).next('small').text('Este campo es requerido.').show(); // Mostrar mensaje de validación
                    } else {
                        $(this).removeClass('is-invalid'); // Marcar campo como válido si se ha completado correctamente
                        $(this).addClass('is-valid'); // Marcar campo como válido
                        $(this).next('.invalid-feedback').hide(); // Ocultar mensaje de validación de error si estaba visible
                        $(this).next('.valid-feedback').show(); // Mostrar mensaje de validación de éxito
                        $(this).next('small').text('').hide(); // Ocultar mensaje de validación si es válido
                    }
                });
                return isValid;
            }

            // Función para validar el patrón de un campo
            function validatePattern(input) {
                var pattern = input.attr('pattern');
                if (!pattern) return true; // Si no hay patrón, devolver true
                var regex = new RegExp(pattern);
                return regex.test(input.val());
            }

            // Activar SweetAlert cuando se hace clic en el botón de guardar
            $('#btnGuardar').click(function() {
                $('#FormSave').submit(); // Simular envío del formulario al hacer clic en el botón de guardar
            });
        });
	</script>

	<script>
		// Capturar el evento de entrada en el campo de texto 'usuario_nombre'
        document.getElementById('usuario_nombre').addEventListener('input', function(event) {
            var input = event.target; // Obtener el campo de texto
            var value = input.value; // Obtener el valor del campo de texto

            // Convertir la primera letra a mayúscula y mantener el resto en minúscula
            input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
        });

        // Capturar el evento de entrada en el campo de texto 'usuario_apepaterno'
        document.getElementById('usuario_apepaterno').addEventListener('input', function(event) {
            var input = event.target; // Obtener el campo de texto
            var value = input.value; // Obtener el valor del campo de texto

            // Convertir la primera letra a mayúscula y mantener el resto en minúscula
            input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
        });

        // Capturar el evento de entrada en el campo de texto 'usuario_apematerno'
        document.getElementById('usuario_apematerno').addEventListener('input', function(event) {
            var input = event.target; // Obtener el campo de texto
            var value = input.value; // Obtener el valor del campo de texto

            // Convertir la primera letra a mayúscula y mantener el resto en minúscula
            input.value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
        });
	</script>
	
    <!-- Incluir el fragmento de JavaScript -->
    <div th:include="home :: javascript-include"></div>
    
    <script th:inline="javascript">
    var errorField = /*[[${errorField}]]*/ 'dni';
    var inputField = document.getElementById('input' + errorField.charAt(0).toUpperCase() + errorField.slice(1));
    
    inputField.focus();
    
    inputField.value = '';
</script>
</body>
</html>